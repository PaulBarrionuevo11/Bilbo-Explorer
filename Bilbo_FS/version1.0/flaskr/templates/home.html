<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <style>
        .charts-row {
            display: flex;
            justify-content: space-around;
            margin: 20px;
        }
        .chart-container {
            width: 30%;
            height: 300px;
            border: 1px solid #ccc; /* Debug border */
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="charts-row">
        <div class="chart-container">
            <canvas id="sensorChart1"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="sensorChart2"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="sensorChart3"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Format time as HH:mm:ss
        function formatTime(date) {
            return date.toTimeString().split(' ')[0];
        }

        // Initialize chart
        function initializeChart(canvasId, label, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas not found: ${canvasId}`);
                return null;
            }
            console.log(`Initialized chart: ${canvasId}`);
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        backgroundColor: color.replace('1)', '0.2)'),
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (HH:mm:ss)', color: '#000' },
                            ticks: { color: '#000' },
                            grid: { color: '#ccc' }
                        },
                        y: {
                            title: { display: true, text: label, color: '#000' },
                            ticks: { color: '#000' },
                            grid: { color: '#ccc' },
                            suggestedMin: -2,
                            suggestedMax: 2
                        }
                    },
                    plugins: {
                        legend: { display: true, labels: { color: '#000' } }
                    }
                }
            });
        }

        // Initialize charts
        const sensorChart1 = initializeChart('sensorChart1', 'Accel X (g)', 'rgb(119, 190, 240)');
        const sensorChart2 = initializeChart('sensorChart2', 'Accel Y (g)', 'rgb(74, 151, 130)');
        const sensorChart3 = initializeChart('sensorChart3', 'Accel Z (g)', 'rgb(255, 107, 107)');

        // Update chart
        function updateChart(chart, value, time) {
            if (!chart) return;
            const val = parseFloat(value);
            if (isNaN(val)) {
                console.warn(`Invalid value for chart: ${value}`);
                return;
            }
            chart.data.labels.push(time || formatTime(new Date()));
            chart.data.datasets[0].data.push(val);
            if (chart.data.labels.length > 2000) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
            console.log(`Updated chart with value: ${val}`);
        }

        // Fetch sensor data
        function fetchSensorData() {
            fetch('http://10.0.0.110:5001/get-sensor-data') // Replace <server-ip>
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('Received:', data);
                    const time = formatTime(new Date());
                    if (data.accelX !== undefined) updateChart(sensorChart1, data.accelX, time);
                    if (data.accelY !== undefined) updateChart(sensorChart2, data.accelY, time);
                    if (data.accelZ !== undefined) updateChart(sensorChart3, data.accelZ, time);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    // Fallback: Add zero values to keep charts moving
                    const time = formatTime(new Date());
                    updateChart(sensorChart1, 0, time);
                    updateChart(sensorChart2, 0, time);
                    updateChart(sensorChart3, 0, time);
                });
        }

        // Fetch every 1 second
        setInterval(fetchSensorData, 1000);
        fetchSensorData();
    </script>
</body>
</html>