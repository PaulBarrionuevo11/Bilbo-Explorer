{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="charts-row">
    <div class="chart-container">
        <canvas id="accelChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="gyroChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Format time as HH:mm:ss
    function formatTime(date) {
        return date.toTimeString().split(' ')[0];
    }

    // Initialize chart
    function initializeChart(canvasId, datasets, yAxisConfig) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error(`Canvas not found: ${canvasId}`);
            return null;
        }
        console.log(`Initialized chart: ${canvasId}`);
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: '#3c4958' }
                    },
                    y: yAxisConfig
                },
                plugins: {
                    legend: { display: true, labels: { color: '#fff' } }
                }
            }
        });
    }

    // Initialize charts
    const accelChart = initializeChart('accelChart', [
        {
            label: 'Accel X (g)',
            data: [],
            borderColor: 'rgb(119, 190, 240)',
            backgroundColor: 'rgba(119, 190, 240, 0.2)',
            fill: false,
            tension: 0.4
        },
        {
            label: 'Accel Y (g)',
            data: [],
            borderColor: 'rgb(74, 151, 130)',
            backgroundColor: 'rgba(74, 151, 130, 0.2)',
            fill: false,
            tension: 0.4
        },
        {
            label: 'Accel Z (g)',
            data: [],
            borderColor: 'rgb(255, 107, 107)',
            backgroundColor: 'rgba(255, 107, 107, 0.2)',
            fill: false,
            tension: 0.4
        }
    ], {
        type: 'linear',
        position: 'left',
        title: { display: true, text: 'Acceleration (g)', color: '#fff' },
        ticks: { color: '#fff' },
        grid: { color: '#3c4958' },
        suggestedMin: -2,
        suggestedMax: 2
    });

    const gyroChart = initializeChart('gyroChart', [
        {
            label: 'Gyro X (째/s)',
            data: [],
            borderColor: 'rgb(255, 215, 0)',
            backgroundColor: 'rgba(255, 215, 0, 0.2)',
            fill: false,
            tension: 0.4
        },
        {
            label: 'Gyro Y (째/s)',
            data: [],
            borderColor: 'rgb(153, 102, 255)',
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            fill: false,
            tension: 0.4
        },
        {
            label: 'Gyro Z (째/s)',
            data: [],
            borderColor: 'rgb(255, 159, 64)',
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            fill: false,
            tension: 0.4
        }
    ], {
        type: 'linear',
        position: 'left',
        title: { display: true, text: 'Gyroscope (째/s)', color: '#fff' },
        ticks: { color: '#fff' },
        grid: { color: '#3c4958' },
        suggestedMin: -5,
        suggestedMax: 5
    });

    // Update chart
    function updateChart(chart, values, time) {
        if (!chart) {
            console.error('Chart not initialized');
            return;
        }
        const valArray = values.map(v => parseFloat(v) || 0);
        if (valArray.some(v => isNaN(v))) {
            console.warn(`Invalid values: ${JSON.stringify(values)}`);
        }

        chart.data.labels.push(time || formatTime(new Date()));
        chart.data.datasets.forEach((dataset, index) => {
            dataset.data.push(valArray[index]);
        });

        if (chart.data.labels.length > 2000) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(dataset => dataset.data.shift());
        }

        chart.update();
        console.log(`Updated ${chart.canvas.id} with values: ${JSON.stringify(valArray)}`);
    }

    // Fetch sensor data
    function fetchSensorData() {
        fetch('http://10.0.0.110:5001/get-sensor-data')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('Received:', data);
                const time = formatTime(new Date());
                updateChart(accelChart, [data.accelX, data.accelY, data.accelZ], time);
                updateChart(gyroChart, [data.gyroX, data.gyroY, data.gyroZ], time);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                const time = formatTime(new Date());
                updateChart(accelChart, [0, 0, 0], time);
                updateChart(gyroChart, [0, 0, 0], time);
            });
    }

    // Fetch every 1 second
    setInterval(fetchSensorData, 1000);
    fetchSensorData();
</script>
{% endblock %}